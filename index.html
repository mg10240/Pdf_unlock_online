<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🔓 PDF 권한 제거기</title>
  <style>
    /* 다크모드와 기본 스타일 */
    :root {
      --bg-light: #f9fafb;
      --bg-dark: #1f2937;
      --text-light: #111827;
      --text-dark: #f3f4f6;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --gray-light: #9ca3af;
      --gray-dark: #4b5563;
      --error-bg: #fee2e2;
      --error-text: #b91c1c;
    }
    html.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    body {
      margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    html.dark body {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .container {
      background: #fff;
      border-radius: 1rem;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.15);
      padding: 2rem 2.5rem;
    }
    html.dark .container {
      background: #374151;
      box-shadow: 0 8px 24px rgb(255 255 255 / 0.1);
    }
    h1 {
      margin: 0 0 0.5rem 0;
      font-weight: 700;
      font-size: 1.75rem;
      color: var(--text-light);
    }
    html.dark h1 {
      color: var(--text-dark);
    }
    p.description {
      margin: 0 0 1.5rem 0;
      color: var(--gray-light);
      font-size: 0.9rem;
      line-height: 1.4;
    }
    input[type="file"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid var(--gray-light);
      font-size: 1rem;
      color: var(--text-light);
      background: #fff;
      cursor: pointer;
      outline-offset: 2px;
    }
    html.dark input[type="file"] {
      border-color: var(--gray-dark);
      background: #4b5563;
      color: var(--text-dark);
    }
    button {
      margin-top: 1rem;
      width: 100%;
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      padding: 0.75rem 0;
      border: none;
      border-radius: 0.75rem;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: var(--primary-hover);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #loading {
      margin-top: 1.25rem;
      text-align: center;
      user-select: none;
    }
    .spinner {
      margin: 0 auto;
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #progressBarWrapper {
      background: var(--gray-light);
      border-radius: 9999px;
      height: 0.5rem;
      width: 100%;
      margin-top: 1rem;
      overflow: hidden;
    }
    #progressBar {
      background: var(--primary);
      height: 0.5rem;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 9999px;
    }
    #result {
      margin-top: 1.5rem;
      color: var(--success);
      font-weight: 600;
      user-select: none;
    }
    #result a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      user-select: text;
      display: inline-block;
      margin-top: 0.3rem;
    }
    #result a:hover {
      text-decoration: underline;
    }
    #errorBox {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: var(--error-bg);
      color: var(--error-text);
      border-radius: 0.5rem;
      font-size: 0.85rem;
      white-space: pre-wrap;
      user-select: text;
      display: none;
    }
    #errorBox.visible {
      display: block;
    }
    #errorActions {
      margin-top: 0.8rem;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    #errorActions button, #errorActions a {
      background: var(--primary);
      border: none;
      color: white;
      padding: 0.3rem 0.7rem;
      border-radius: 0.375rem;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #errorActions button:hover, #errorActions a:hover {
      background: var(--primary-hover);
    }
  </style>
  <script type="module">
    import createModule from './qpdf.js';
    window.qpdfReady = createModule({
      locateFile: () => './qpdf.wasm',
    });
  </script>
</head>
<body>
  <div class="container" role="main" aria-label="PDF 권한 제거기">
    <h1>🔓 PDF 권한 제거기</h1>
    <p class="description">
      비밀번호가 걸린 PDF에서 권한을 제거해 다운로드하세요.<br />
      모든 처리는 브라우저 내에서 이루어집니다.
    </p>
    <label for="pdfInput" style="display:block; margin-bottom:0.75rem;">
      PDF 파일 선택
      <input id="pdfInput" type="file" accept="application/pdf" />
    </label>
    <button id="processBtn" disabled>권한 제거 실행</button>

    <div id="loading" aria-live="polite" style="display:none;">
      <div class="spinner" role="status" aria-label="로딩 중"></div>
      <p>처리 중입니다...</p>
      <div id="progressBarWrapper">
        <div id="progressBar"></div>
      </div>
    </div>

    <div id="result" style="display:none;">
      ✅ 처리 완료!<br />
      <a id="downloadLink" href="#" download>📥 다운로드 링크</a>
    </div>

    <div id="errorBox" role="alert" aria-live="assertive" tabindex="0" style="display:none;">
      <pre id="errorMessage"></pre>
      <div id="errorActions">
        <button id="copyErrorBtn" type="button">오류 메시지 복사</button>
        <a id="issueLink" href="#" target="_blank" rel="noopener noreferrer">깃허브 이슈 등록</a>
      </div>
    </div>
  </div>

  <script type="module">
    (async () => {
      const processBtn = document.getElementById("processBtn");
      const input = document.getElementById("pdfInput");
      const loading = document.getElementById("loading");
      const progressBar = document.getElementById("progressBar");
      const resultDiv = document.getElementById("result");
      const downloadLink = document.getElementById("downloadLink");
      const errorBox = document.getElementById("errorBox");
      const errorMessage = document.getElementById("errorMessage");
      const copyErrorBtn = document.getElementById("copyErrorBtn");
      const issueLink = document.getElementById("issueLink");

      // qpdf 초기화
      try {
        window.qpdf = await window.qpdfReady;
        processBtn.disabled = false;
      } catch (e) {
        alert("QPDF 초기화 중 오류가 발생했습니다. 콘솔을 확인하세요.");
        console.error(e);
        return;
      }

      function showError(err) {
        const message = `[오류 메시지]\n${err.toString()}\n\n[브라우저 정보]\n${navigator.userAgent}`;
        errorMessage.textContent = message;
        errorBox.style.display = "block";
        errorBox.focus();
        // 본인의 github repo로 변경하세요.
        const repo = "mg10240/Pdf_unlock_online";
        const title = encodeURIComponent("[Bug] PDF 처리 중 오류 발생");
        const body = encodeURIComponent(message);
        issueLink.href = `https://github.com/${repo}/issues/new?title=${title}&body=${body}`;
      }

      copyErrorBtn.onclick = () => {
        navigator.clipboard.writeText(errorMessage.textContent).then(() => {
          alert("오류 메시지가 클립보드에 복사되었습니다!");
        });
      };

      processBtn.onclick = async () => {
        const file = input.files[0];
        if (!file) {
          alert("PDF 파일을 선택해주세요.");
          return;
        }

        errorBox.style.display = "none";
        resultDiv.style.display = "none";
        processBtn.disabled = true;
        loading.style.display = "block";
        progressBar.style.width = "10%";

        try {
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);

          const inputPath = "/input.pdf";
          const outputPath = "/output.pdf";

          window.qpdf.FS.writeFile(inputPath, uint8Array);
          progressBar.style.width = "40%";

          window.qpdf.callMain(["--decrypt", inputPath, outputPath]);
          progressBar.style.width = "80%";

          const result = window.qpdf.FS.readFile(outputPath);
          const blob = new Blob([result], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);

          downloadLink.href = url;
          downloadLink.download = file.name.replace(/\.pdf$/i, "") + "-unlocked.pdf";

          progressBar.style.width = "100%";
          loading.style.display = "none";
          resultDiv.style.display = "block";
        } catch (e) {
          loading.style.display = "none";
          showError(e);
        } finally {
          processBtn.disabled = false;
          progressBar.style.width = "0%";
        }
      };

      input.addEventListener("change", () => {
        if (input.files.length === 1) {
          processBtn.disabled = false;
          errorBox.style.display = "none";
          resultDiv.style.display = "none";
        } else {
          processBtn.disabled = true;
        }
      });
    })();
  </script>
</body>
</html>
